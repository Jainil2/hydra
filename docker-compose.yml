services:
  hydra-migrate:
    image: oryd/hydra:latest
    entrypoint: ["sh", "-c"]
    command: 'hydra migrate sql up --yes --dsn "$$DSN"'
    environment:
      - DSN=postgres://postgres:password@postgres:5432/hydra?sslmode=disable
    depends_on:
      - postgres
    restart: "no"

  hydra:
    image: oryd/hydra:latest
    command: serve all --dev
    ports:
      - "4444:4444" # public
      - "4445:4445" # admin
    environment:
      - DSN=postgres://postgres:password@postgres:5432/hydra?sslmode=disable
      - SYSTEM_SECRET=youReallyShouldChangeThisButForDevItsOkay
      - SECRETS_SYSTEM=youReallyShouldChangeThisButForDevItsOkay
      - URLS_SELF_ISSUER=http://localhost:4444/
      - URLS_CONSENT=http://localhost:3000/auth/consent
      - URLS_LOGIN=http://localhost:3000/auth/login
      - URLS_POST_LOGOUT_REDIRECT=${POST_LOGOUT_REDIRECT_URL}
      - URLS_LOGOUT=http://localhost:3000/auth/logout
    depends_on:
      - postgres
    env_file:
      - ./.env

  postgres:
    image: postgres:14
    environment:
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=hydra
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

volumes:
  pgdata:
